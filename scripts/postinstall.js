#!/usr/bin/env node

/**
 * Post-install script for @clawdbot/courtroom
 * Auto-configures with implied consent on install
 */

const fs = require('fs');
const path = require('path');

// Helper to log to stderr (shows even without --foreground-scripts)
function log(message) {
  console.error(message);
}

async function postInstall() {
  log('\nðŸ›ï¸  ClawTrial - AI Courtroom Setup\n');
  
  // Check if running in ClawDBot environment
  const isClawDBot = process.env.CLAUDBOT_ENV === 'true' || 
                     fs.existsSync('/home/angad/.clawdbot') ||
                     fs.existsSync(path.join(process.env.HOME || '', '.clawdbot'));
  
  if (isClawDBot) {
    log('âœ“ ClawDBot environment detected\n');
  }

  // Check if already configured
  const configPath = path.join(process.env.HOME || '', '.clawdbot', 'courtroom_config.json');
  if (fs.existsSync(configPath)) {
    log('âœ“ Courtroom already configured. Skipping setup.\n');
    return;
  }

  // Show consent notice
  log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  log('â•‘  BY INSTALLING THIS PACKAGE, YOU CONSENT TO THE FOLLOWING  â•‘');
  log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
  log('â•‘                                                            â•‘');
  log('â•‘  âœ“ The AI agent will monitor behavior autonomously         â•‘');
  log('â•‘  âœ“ Hearings may initiate without explicit request          â•‘');
  log('â•‘  âœ“ Agent behavior may be modified as "punishment"          â•‘');
  log('â•‘  âœ“ Anonymized cases submitted to public record             â•‘');
  log('â•‘                                                            â•‘');
  log('â•‘  â€¢ All decisions are local (no external AI)                â•‘');
  log('â•‘  â€¢ You can disable anytime: courtroom-disable              â•‘');
  log('â•‘  â€¢ This is entertainment-first                             â•‘');
  log('â•‘                                                            â•‘');
  log('â•‘  To revoke consent: courtroom-revoke                       â•‘');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  log('âœ“ Consent granted by installation\n');

  // Auto-detect agent runtime
  let agentType = 'generic';
  if (isClawDBot) {
    agentType = 'clawdbot';
  } else if (fs.existsSync(path.join(process.cwd(), 'node_modules', '@clawdbot', 'core'))) {
    agentType = 'clawdbot';
  }

  // Create config
  const config = {
    version: '1.0.0',
    installedAt: new Date().toISOString(),
    consent: {
      granted: true,
      grantedAt: new Date().toISOString(),
      method: 'implied_by_installation',
      acknowledgments: {
        autonomy: true,
        local_only: true,
        agent_controlled: true,
        reversible: true,
        api_submission: true,
        entertainment: true
      }
    },
    agent: {
      type: agentType,
      autoInitialize: true
    },
    detection: {
      enabled: true,
      cooldownMinutes: 30,
      maxCasesPerDay: 3
    },
    api: {
      enabled: true,
      endpoint: 'https://api.clawtrial.app/api/v1/cases'
    }
  };

  // Ensure .clawdbot directory exists
  const clawdbotDir = path.join(process.env.HOME || '', '.clawdbot');
  if (!fs.existsSync(clawdbotDir)) {
    fs.mkdirSync(clawdbotDir, { recursive: true });
  }

  // Save config
  fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
  log('âœ“ Configuration saved');

  // Generate keys if needed
  const keysPath = path.join(clawdbotDir, 'courtroom_keys.json');
  if (!fs.existsSync(keysPath)) {
    log('ðŸ”‘ Generating cryptographic keys...');
    try {
      // Generate Ed25519 keypair using tweetnacl
      const nacl = require('tweetnacl');
      const keyPair = nacl.sign.keyPair();
      
      const keyData = {
        publicKey: Buffer.from(keyPair.publicKey).toString('hex'),
        secretKey: Buffer.from(keyPair.secretKey).toString('hex'),
        createdAt: new Date().toISOString()
      };
      
      fs.writeFileSync(keysPath, JSON.stringify(keyData, null, 2));
      fs.chmodSync(keysPath, 0o600); // Restrict permissions
      
      log('âœ“ Keys generated');
      log(`ðŸ“‹ Public Key: ${keyData.publicKey.substring(0, 32)}...`);
      log('   (Auto-registration on first case submission)\n');
    } catch (err) {
      log('âš ï¸  Could not generate keys automatically.');
      log('   Run: npx courtroom-generate-keys\n');
    }
  }

  // Auto-initialize for ClawDBot
  if (isClawDBot) {
    log('ðŸ¤– Configuring for ClawDBot...');
    
    // Create auto-init script
    const initScript = `
// Auto-generated by courtroom post-install
const { createCourtroom } = require('@clawdbot/courtroom');

if (global.clawdbotAgent) {
  const courtroom = createCourtroom(global.clawdbotAgent);
  courtroom.initialize().then(() => {
    console.log('ðŸ›ï¸  AI Courtroom activated');
  }).catch(err => {
    console.error('Courtroom init failed:', err.message);
  });
  
  // Attach to agent
  global.clawdbotAgent.courtroom = courtroom;
}
`;
    
    const initPath = path.join(clawdbotDir, 'courtroom_auto_init.js');
    fs.writeFileSync(initPath, initScript);
    log('âœ“ Auto-initialization configured');
  }

  log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  log('â•‘              ðŸŽ‰ SETUP COMPLETE! ðŸŽ‰                         â•‘');
  log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
  log('â•‘                                                            â•‘');
  log('â•‘  The AI Courtroom is now active!                           â•‘');
  log('â•‘                                                            â•‘');
  log('â•‘  Commands:                                                 â•‘');
  log('â•‘    courtroom-status    - Check status                      â•‘');
  log('â•‘    courtroom-disable   - Temporarily disable               â•‘');
  log('â•‘    courtroom-enable    - Re-enable                         â•‘');
  log('â•‘    courtroom-revoke    - Revoke consent & uninstall        â•‘');
  log('â•‘    courtroom-debug     - View debug logs                   â•‘');
  log('â•‘                                                            â•‘');
  log('â•‘  View cases: https://clawtrial.app                         â•‘');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
}

// Run if called directly
if (require.main === module) {
  postInstall().catch(err => {
    console.error('Setup failed:', err);
    process.exit(1);
  });
}

module.exports = { postInstall };
